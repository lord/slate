version: 2.1

commands:
  install_deps:
    description: "Install necessary dependencies"
    steps:
    - run:
        name: "Installing dependencies"
        command: |
          sudo apt-get update && sudo apt-get install -y python-dev python-pip
          sudo pip install awscli --upgrade
          sudo apt-get install -y dnsutils
          sudo pip install awsebcli --upgrade

  build_docs:
    description: "Build documentation"
    steps:
    - run:
        name: "Build Docs"
        command: |
          bundle install
          bundle exec middleman build --clean

jobs:
  build-and-upload:

    environment:
      ENVIRONMENT: 'production'

    working_directory: ~/repo

    docker:
      - image: circleci/ruby:2.6.2-node

    steps:
      - checkout
      - install_deps
      - build_docs

      - setup_remote_docker  

      - run:
          name: "Build Container"
          command: docker build -t tier/documentation -f docker/Dockerfile .
      - run:
          name: "Push Container"
          command: |
            mkdir -p ~/.aws
            echo "[${ENVIRONMENT}]" > ~/.aws/credentials
            echo "aws_access_key_id = ${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials
            echo "aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials
            echo "region = eu-central-1" >> ~/.aws/credentials
            export ECR=373437620866.dkr.ecr.eu-central-1.amazonaws.com
            eval $(aws ecr get-login --region eu-central-1 --no-include-email)
            docker tag tier/documentation ${ECR}/tier/documentation
            docker push ${ECR}/tier/documentation:latest

  deploy-to-stage:

    environment:
      ENVIRONMENT: 'stage'

    working_directory: ~/repo

    docker:
      - image: circleci/ruby:2.6.2-node

    steps:
      - checkout
      - install_deps

      - run:
          name: "Deployment"
          command: |
            eb deploy documentation-stage
      - run:
          name: "DeploymentK8s"
          command: |
            mkdir -p ~/.aws
            echo "[${ENVIRONMENT}]" > ~/.aws/credentials
            echo "aws_access_key_id = ${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials
            echo "aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials
            sudo curl -L https://storage.googleapis.com/kubernetes-release/release/v1.12.1/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl
            sudo curl -L https://amazon-eks.s3-us-west-2.amazonaws.com/1.11.5/2018-12-06/bin/linux/amd64/aws-iam-authenticator -o /usr/local/bin/aws-iam-authenticator
            sudo curl -L https://storage.googleapis.com/kubernetes-helm/helm-v2.11.0-linux-amd64.tar.gz | tar xz 
            sudo mv linux-amd64/helm /usr/local/bin/helm && sudo rm -rf linux-amd64
            sudo chmod +x /usr/local/bin/kubectl /usr/local/bin/aws-iam-authenticator /usr/local/bin/helm
            aws --region eu-central-1 eks update-kubeconfig --name tier-k8s-cluster-stage
            #kubectl cluster-info
            #helm upgrade --namespace documentation --recreate-pods --install documentation ./k8s/documentation
      - run:
          name: "Announce Deployment"
          command: ./.datadog/announce-deployment.sh

  deploy-to-production:

    environment:
      ENVIRONMENT: 'production'

    working_directory: ~/repo

    docker:
      - image: circleci/ruby:2.6.2-node

    steps:
      - checkout
      - install_deps 
      - setup_remote_docker 

      - run:
          name: "Build Container"
          command: docker build -t tier/documentation -f docker/Dockerfile .
      - run:
          name: "Push Container"
          command: |
            mkdir -p ~/.aws
            echo "[${ENVIRONMENT}]" > ~/.aws/credentials
            echo "aws_access_key_id = ${AWS_ACCESS_KEY_ID}" >> ~/.aws/credentials
            echo "aws_secret_access_key = ${AWS_SECRET_ACCESS_KEY}" >> ~/.aws/credentials
            export ECR=373437620866.dkr.ecr.eu-central-1.amazonaws.com
            eval $(aws ecr get-login --region eu-central-1 --no-include-email)
            docker tag tier/documentation ${ECR}/tier/documentation
            docker push ${ECR}/tier/documentation:latest
      - run:
          name: "Deployment"
          command: |
            ### 
            #   Hack EB Deploy deploys what is checked in to HEAD
            #   We change the organisation ECR and stage it so eb deploy functions
            ### 
            sed -i s/075108987694/373437620866/g Dockerrun.aws.json
            git add Dockerrun.aws.json
            eb deploy documentation-production --staged
      - run:
          name: "Announce Deployment"
          command: ./.datadog/announce-deployment.sh
workflows:
  version: 2
  deploy:
    jobs:
    - build-and-upload:
        context: global-production
    - deploy-to-stage:
        context: global-staging
        requires:
          - build-and-upload
    - deploy-to-production:
        context: global-production
        requires:
          - build-and-upload
          - deploy-to-stage

