Giosg Apps (Developer preview)
==========

<aside class="warning">
This documentation is a <strong>draft</strong>!
</aside>

Giosg Apps allow developers to develop own applications for giosg Live chat and embed them inside operator console much like canvas apps in Facebook.

Idea and usage of Giosg Apps is basically the same as in Facebook. You need to develop your own application with web technologies of your choice (examples and libs will be available for Angular-Meteor, Meteor and Django) and deploy to your own servers. You can then create your application to giosg.

Creating your application means defining name, description, image and application url. You also need to decide when the application will run and what permissions it needs. After saving you are ready to install and use the application.

## Application launch conditions
There are few different situation where applications can run. Application can run on background (Ie. no UI is shown to user) when console loads, chat starts or chat ends.

Applications can also run with visible UI when launched manually from chat dialog or from console top navigation. Running with visible UI means that the application is iframed in console either on own dialog or on the side of chat dialog.

## Application Request
When application is launched a launch url will be generated for application. This url is combinations of configured application url and query string parameters generated by giosg. This url is then returned to client and client will create iframe with this url which results to GET requests to application. Data in query strings parameters is encoded to [JWT tokens](http://jwt.io/).

### List of parameters in application request

Parameter   | Type   | Description
------------|--------|----------
`type` | string | Type of request. Can be one of `manual_dialog`, `manual_nav`, `chat_start`, `chat_end` or `console_load`.
`data` | JWT token | JWT Token signed with application secret. This contains data that application can use. See **List of fields in data JWT Token** below.
`token` | JWT token | JWT token signed with giosg secret. This is used to authenticate with giosg HTTP Apis. See **List of fields in token JWT Token** below.

```
// Example of application request url:
https://myappp.com/app.html?type=chat_start&data=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb21pY191cmwiOiJodHRwOi8veGtjZC5jb20vMTM2MC8ifQ.BsjBt9a9imoj9P5_7aIAe5nuhPd5jb8HGvAJKPCwm6A&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb21pY191cmwiOiJodHRwOi8veGtjZC5jb20vMTM2MC8ifQ.BsjBt9a9imoj9P5_7aIAe5nuhPd5jb8HG
```

**List of fields in `data` JWT Token**

Field   | Type   | Description
------------|--------|----------
`sub` | string | Subject of the token. Ie. `service.giosg.com`.
`exp` | timestamp | Token expiration timestamp. Automatically used by most JWT implementations to make sure that token is not expired.
`user_id` | UUID | UUID of the current user or `None` if not applicable.
`org_id` | UUID | UUID of the organization/company where the `user_id` belongs to.
`chat_id` | UUID | UUID of the chat sessions if applicable or `None`.
`visitor_id` | VisitorID | ID of the visitor if applicable or `None`.
`inst_id` | UUID | UUID of the application instance/installation.
`app_id` | UUID | UUID of the application definition.

**List of parameters `token` JWT Token**

Field   | Type   | Description
------------|--------|----------
`sub` | string | Subject of the token. Ie. `service.giosg.com`.
`exp` | timestamp | Token expiration timestamp. Automatically used by most JWT implementations to make sure that token is not expired.
`user_id` | UUID | UUID of the current user or `None` if not applicable.
`org_id` | UUID | UUID of the organization/company where the `user_id` belongs to.
`inst_id` | UUID | UUID of the application instance/installation.
`app_id` | UUID | UUID of the application definition.
`perms` | List of strings |  List of strings representing applications permission


### Why two JWT tokens?
There is two almost identical JWT tokens. First one, **auth** token,  is  for application server so that it can verify that the request was made by giosg and data was not tampered by anyway in the client. Another token is for giosg so that when application signs it's API calls with this token and app secret giosg can trust that the request originated from correct place.

## Background Application Request
When application is run on background requests is made with celery and requests library. Normal GET request is made to application url with parameters in query string. This all the same as with normal application request except that the UI is not shown to user and javascript will not run.

## Logging
Application runs are always logged to log that is visible for the managers. This log contains information specially intended for debugging background requests.

## Application authentication and Application secret
When application is created an unique application secret will be generated for the application. Application need this secret key to authenticate to giosg. When applications request is made the receiving app receives JWT token containing request data and another token for authentication with giosg API's.

Applications can then verify the first token that was signed with the application secret so that they can trust data sent by giosg.

Clients (apps) should authenticate by passing both the JWT token that was provided in **token** query parameter and application secret in the "Authorization" HTTP header separated with space. "Authorization" header should be prefixed with **GIOSGAPP**.

```
    Example:
        Auth token grabbed from request params:
            abcdefghiklmopqrstuvwxyz0213456789
        Giosg App Secret:
            axyz0213456bcdelmopqrstuvw789fghik
        Concatenate like this:
            auth = "{token} {secret}"

        Authorization: GIOSGAPP abcdefghiklmopqrstuvwxyz0213456789 axyz0213456bcdelmopqrstuvw789fghik
```

## SSL is required for apps to work
Applications are required to use SSL in order to be accepted as Giosg Apps. Currently UI allows saving pretty much anything as application url but requests will fail if the url doesn't start with HTTPS.

To develop apps locally it is possible to allow insecure urls by setting `allow_insecure_url` to `True` manually on database. No UI is provided for this to not make it too easy for some weak minded people to allow this for our customers! ;) Another possibility is to generate self signed certificate.

For production apps it is also possible to get free certificates from StartSSL and some other providers. Also it is possible to use CloudFlare in front of the app to get SSL for free.

# Example apps
Here are some example applications and boilerplates that you can use when you start building your own application. All of the apps are open source and can be used anyway you wish.

<aside class="info">
Examples are not available yet! Please check back soon!
</aside>
